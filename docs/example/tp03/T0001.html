<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Welcome to the web interface of DyCon Toolbox, the computational platform developed within the <a href='https://cmc.deusto.eus/dycon/' target='_blank'>ERC DyCon - Dynamic Control</a> project.">



	<link rel='shortcut icon' type='image/png' href='/dycon-toolbox-documentation/favicon.png' />

    <title>Average Control - DyCon Toolbox</title>

    <link rel="canonical" href="https://DeustoTech.github.io/dycon-toolbox-documentation/example/tp03/T0001">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://DeustoTech.github.io/dycon-toolbox-documentation/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://DeustoTech.github.io/dycon-toolbox-documentation/css/clean-blog.css">

	<!-- Adjust Colors -->
    <link rel="stylesheet" href="https://DeustoTech.github.io/dycon-toolbox-documentation/colorscheme.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="https://DeustoTech.github.io/dycon-toolbox-documentation/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
  	<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
  	<link href="https://fonts.googleapis.com/css?family=Lusitana" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
	<!-- Math Jax -->
	<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']]
    },
		TeX: {
      equationNumbers: {
        autoNumber: "AMS"
      }
    }
	});
	</script>

	<!--<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js" type="text/javascript"></script>-->

    <!-- jQuery -->
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

	<!-- Bootstrap Core JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

	<!-- Custom Theme JavaScript -->
    <script src="https://DeustoTech.github.io/dycon-toolbox-documentation/js/clean-blog.min.js "></script>
    
 	<!-- 404  JavaScript -->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/dycon-toolbox-documentation/">
                 <img src="https://DeustoTech.github.io//dycon-toolbox-documentation/assets/logo_DyConToolbox_v001.png" >
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/dycon-toolbox-documentation/">Home</a>
                </li>
                
                
                <li>
                    <a href="/dycon-toolbox-documentation/projects/01-documentation">Documentation</a>
                </li>
                
                
                
                <li>
                    <a href="/dycon-toolbox-documentation/projects/02-tutorials">First Steps</a>
                </li>
                
                
                
                <li>
                    <a href="/dycon-toolbox-documentation/projects/03-examples">Examples</a>
                </li>
                
                
                
                <li>
                    <a href="/dycon-toolbox-documentation/projects/04-download">Downloads</a>
                </li>
                
                
                
                <li>
                        <a href="http://cmc.deusto.eus/">Chair of Computational Mathematics</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header">
    <div class="container" style="padding-top: 70px;">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading" style="padding: 0px 0"><h2><small>Example of <a href="https://DeustoTech.github.io//dycon-toolbox-documentation/example/Tp03">Parameter dependent problems</a> :</small></h2>
                    <h1>Average Control</h1>
					</span>
					<div class="shadowbox">
						<p>To start this tutorial, write the following command in the MATLAB console
							<pre class="highlight"><code><span class="nb">open T0006_average</span></code></pre>
						</p>
					</div>


                </div>
            </div>
		</div>


	</div>
</header>


<!-- Post Content -->
<style>
img {
	display:block;
	max-width:  100%;
	margin-left: auto;
	margin-right: auto;
}

@media only screen and (min-width: 1000px) {
img {
	-moz-transition:-moz-transform 0.5s ease-in; 
	-webkit-transition:-webkit-transform 0.5s ease-in; 
	-o-transition:-o-transform 0.5s ease-in;
}
img:active{
	-moz-transform:scale(1.2); 
	-webkit-transform:scale(1.2);
	-o-transform:scale(1.2);
}
}

@media only screen and (min-width: 1250px) {
img {
	-moz-transition:-moz-transform 0.5s ease-in; 
	-webkit-transition:-webkit-transform 0.5s ease-in; 
	-o-transition:-o-transform 0.5s ease-in;
}
img:active{
	-moz-transform:scale(1.5); 
	-webkit-transform:scale(1.5);
	-o-transform:scale(1.5);
}
}

@media only screen and (min-width: 1500px) {
img {
	-moz-transition:-moz-transform 0.5s ease-in; 
	-webkit-transition:-webkit-transform 0.5s ease-in; 
	-o-transition:-o-transform 0.5s ease-in;
}
img:active{
	-moz-transform:scale(2); 
	-webkit-transform:scale(2);
	-o-transform:scale(2);
}
}
</style>

<article>
    <div id="content" class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<p>In this work, we address the concept of optimal control of parameter-dependent systems. We introduce the notion of averaged control in which the quantity of interest is the average of the states with respect to the parameter family <script type="math/tex">\mathcal{K}= \left\{ \nu_i \in \mathbb{R}, \enspace 1\leq i \leq K \right\}.</script></p>

<p>Our objective it to solve the minimization problem</p>

<script type="math/tex; mode=display">\begin{equation*} \min_{u \in L^2(0,T)} \mathcal{J}\left( u\right) = \min_{u \in L^2(0,T)} \frac{1}{2} \left[ \frac{1}{|\mathcal{K}|} \sum_{\nu \in \mathcal{K}} x \left( T, \nu \right) - \bar{x} \right]^2  + \frac{\beta}{2} \int_0^T u^2 \mathrm{d}t, \quad \beta \in \mathbb{R}^+ \end{equation*}</script>

<p>Subject to the finite dimensional linear control system</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*}  \left\{ \begin{array}{ll} x^\prime \left( t \right) = A \left( \nu \right) x \left( t \right) + B \left( \nu \right) u \left( t \right), \quad 0 < t <T, \\ x\left( 0 \right) = x^0. \end{array} \right. \end{align*} %]]></script>

<p>Then, a control $u\left( t \right)$ independent of the parameter $\nu$ will be performed in order to minimize the distance between the average of the final states and a given final target.</p>

<p>In this case $\nu_i$ are</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">;</span>
</code></pre></div></div>

<p>Size of state vector</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">N</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">M</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">nu</span><span class="p">);</span>

<span class="n">Am</span> <span class="o">=</span> <span class="nb">eye</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
<span class="k">for</span> <span class="nb">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">N</span>
    <span class="k">for</span> <span class="nb">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">N</span>
        <span class="k">if</span> <span class="nb">j</span> <span class="o">&gt;</span> <span class="nb">i</span>
            <span class="n">Am</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span> <span class="nb">j</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
<span class="n">Am</span> <span class="o">=</span> <span class="o">-</span><span class="n">Am</span><span class="p">;</span>

<span class="n">Bm</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">Bm</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">A</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="o">*</span><span class="n">N</span><span class="p">);</span>
<span class="n">B</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">for</span> <span class="nb">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">M</span>
    <span class="n">Ainit</span> <span class="o">=</span> <span class="n">N</span><span class="o">*</span><span class="p">(</span><span class="nb">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">Aend</span>  <span class="o">=</span> <span class="n">N</span><span class="o">*</span><span class="nb">j</span><span class="p">;</span>

    <span class="n">A</span><span class="p">(</span><span class="n">Ainit</span><span class="p">:</span><span class="n">Aend</span><span class="p">,</span><span class="n">Ainit</span><span class="p">:</span><span class="n">Aend</span><span class="p">)</span> <span class="o">=</span> <span class="n">Am</span> <span class="o">+</span> <span class="p">(</span><span class="n">nu</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span><span class="o">*</span><span class="nb">diag</span><span class="p">(</span><span class="nb">diag</span><span class="p">(</span><span class="n">Am</span><span class="p">));</span>
    <span class="n">B</span><span class="p">(</span><span class="n">Ainit</span><span class="p">:</span><span class="n">Aend</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">Bm</span><span class="p">;</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We take as final target</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xt</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<p>We can use the classical gradient descent method based on the adjoint methodology to obtain the iterative method in order to compute the optimal control. Applying this methodology we obtain the corresponding adjoint system for <sup id="fnref:fn"><a href="#fn:fn" class="footnote">1</a></sup>,</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*} \left\{ \begin{array}{ll} p^\prime \left( t, \nu \right) = -A \left( \nu \right) p \left( t,\nu \right), \quad 0 < t <T, \\ \displaystyle p\left( T \right) = - \left[ \frac{1}{|\mathcal{K}|} \sum_{\nu \in \mathcal{K}} x \left( T, \nu \right) - \bar{x} \right]. \end{array} \right. \end{align*} %]]></script>

<p>To minimize the functional, $\mathcal{J}\left( u\right)$, we take the steepest descent direction given by</p>

<script type="math/tex; mode=display">\begin{equation*} u^{\left( k+1 \right)} = u^{\left( k \right)} - \gamma \left( \beta u^{\left( k \right)}-\frac{1}{|\mathcal{K}|} \sum_{\nu \in \mathcal{K}} B^{\top}p \left( t,\nu \right) \right) \end{equation*}</script>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iode</span> <span class="o">=</span> <span class="n">ode</span><span class="p">(</span><span class="s1">'A'</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="s1">'B'</span><span class="p">,</span><span class="n">B</span><span class="p">);</span>
<span class="n">Y0</span> <span class="o">=</span> <span class="nb">ones</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">iode</span><span class="o">.</span><span class="n">Condition</span> <span class="o">=</span> <span class="nb">repmat</span><span class="p">(</span><span class="n">Y0</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">iode</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Ys</span> <span class="o">=</span> <span class="n">iode</span><span class="o">.</span><span class="n">VectorState</span><span class="o">.</span><span class="n">Symbolic</span><span class="p">;</span>
<span class="n">U</span>  <span class="o">=</span> <span class="n">iode</span><span class="o">.</span><span class="n">Control</span><span class="o">.</span><span class="n">Symbolic</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Ysm</span> <span class="o">=</span> <span class="nb">arrayfun</span><span class="p">(</span><span class="o">@</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="nb">mean</span><span class="p">(</span><span class="n">Ys</span><span class="p">(</span><span class="n">index</span><span class="p">:</span><span class="n">M</span><span class="p">:</span><span class="n">N</span><span class="o">*</span><span class="n">M</span><span class="p">)),</span><span class="mi">1</span><span class="p">:</span><span class="n">M</span><span class="p">)</span><span class="o">.'</span><span class="p">;</span>
<span class="n">Yt</span> <span class="o">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">Psi</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ysm</span> <span class="o">-</span> <span class="n">Yt</span><span class="p">)</span><span class="o">.'*</span><span class="p">(</span><span class="n">Ysm</span> <span class="o">-</span> <span class="n">Yt</span><span class="p">);</span>
<span class="nb">beta</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">;</span>
<span class="n">L</span>   <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">beta</span><span class="o">*</span><span class="n">U</span><span class="o">.'*</span><span class="n">U</span><span class="p">;</span>
</code></pre></div></div>

<p>Create the optimal control</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iCP1</span> <span class="o">=</span> <span class="n">OptimalControl</span><span class="p">(</span><span class="n">iode</span><span class="p">,</span><span class="n">Psi</span><span class="p">,</span><span class="n">L</span><span class="p">);</span>
</code></pre></div></div>

<p>Solve</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">GradientMethod</span><span class="p">(</span><span class="n">iCP1</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error = 0
error = 0.24058
error = 0.36374
error = 0.0457
error = 0.044178
error = 0.0044026

    Solve with presicion: 

        We obtain: J(u) = 3.189690E-03

        mean(||dJ_i||) = 4.402552E-03

    With 6 iterations,     In 0.73904 seconds


</code></pre></div></div>

<p>See average free</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">solve</span><span class="p">(</span><span class="n">iode</span><span class="p">)</span>
<span class="n">Yfree</span>    <span class="o">=</span> <span class="n">iode</span><span class="o">.</span><span class="n">VectorState</span><span class="o">.</span><span class="n">Numeric</span><span class="p">;</span>
<span class="n">Ycontrol</span> <span class="o">=</span> <span class="n">iCP1</span><span class="o">.</span><span class="n">ode</span><span class="o">.</span><span class="n">VectorState</span><span class="o">.</span><span class="n">Numeric</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cellstate</span> <span class="o">=</span> <span class="nb">arrayfun</span><span class="p">(</span><span class="o">@</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="nb">mean</span><span class="p">(</span><span class="n">Yfree</span><span class="p">(:,</span><span class="n">index</span><span class="p">:</span><span class="n">M</span><span class="p">:</span><span class="n">N</span><span class="o">*</span><span class="n">M</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="n">M</span><span class="p">,</span><span class="s1">'UniformOutput'</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="n">meanvector</span> <span class="o">=</span> <span class="p">[</span><span class="n">cellstate</span><span class="p">{:}];</span>
<span class="nb">plot</span><span class="p">(</span><span class="n">meanvector</span><span class="p">);</span>
<span class="nb">legend</span><span class="p">(</span><span class="nb">strcat</span><span class="p">(</span><span class="nb">repmat</span><span class="p">(</span><span class="s1">'x_'</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nb">num2str</span><span class="p">((</span><span class="mi">1</span><span class="p">:</span><span class="n">N</span><span class="p">)</span><span class="o">'</span><span class="p">)))</span>
<span class="nb">title</span><span class="p">(</span><span class="s1">'Free Average States'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://DeustoTech.github.io//dycon-toolbox-documentation/assets/imgs/Tp03/T0001/copiaRM_01.png" alt="" /></p>

<p>Average Control</p>

<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cellstate</span> <span class="o">=</span> <span class="nb">arrayfun</span><span class="p">(</span><span class="o">@</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="nb">mean</span><span class="p">(</span><span class="n">Ycontrol</span><span class="p">(:,</span><span class="n">index</span><span class="p">:</span><span class="n">M</span><span class="p">:</span><span class="n">N</span><span class="o">*</span><span class="n">M</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="n">M</span><span class="p">,</span><span class="s1">'UniformOutput'</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="n">meanvector</span> <span class="o">=</span> <span class="p">[</span><span class="n">cellstate</span><span class="p">{:}];</span>
<span class="nb">plot</span><span class="p">(</span><span class="n">meanvector</span><span class="p">);</span>
<span class="nb">legend</span><span class="p">(</span><span class="nb">strcat</span><span class="p">(</span><span class="nb">repmat</span><span class="p">(</span><span class="s1">'x_'</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nb">num2str</span><span class="p">((</span><span class="mi">1</span><span class="p">:</span><span class="n">N</span><span class="p">)</span><span class="o">'</span><span class="p">)))</span>
<span class="nb">title</span><span class="p">(</span><span class="s1">'Control Average States'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://DeustoTech.github.io//dycon-toolbox-documentation/assets/imgs/Tp03/T0001/copiaRM_02.png" alt="" /></p>

<h2 id="references">References</h2>

<div class="footnotes">
  <ol>
    <li id="fn:fn">
      <p>E. Zuazua (2014) Averaged Control. Automatica, 50 (12), p. 3077-3087. <a href="#fnref:fn" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>


                <hr>

            </div>
        </div>
    </div>
</article>


<hr>


    <!-- Footer -->
<footer>
  <hr>
  <div class="container">
    <div class="row">
      <div class="col-md-10">
        <ul class="list-inline text-center">
          <li>
            <img style="width: 200px;" src="/dycon-toolbox-documentation/img/logos/logo_DyCon.png " alt="">
          </li>
          <li>
            <img style="width: 250px;" src="/dycon-toolbox-documentation/img/logos/logo_CCM_subDerecha_v002.png " alt="">
          </li>
        </ul>
      </div>
    </div>
  </div>
</footer>


</body>

</html>
